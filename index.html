<!DOCTYPE html>
<html dir="rtl" lang="fa">
  <head>
    <meta charset="UTF-8" />
    <style>
      @font-face {
        font-family: "IranYekan";
        src: url("./assets/fonts/iranyekanwebregular.woff") format("woff2");
        font-style: normal;
        font-weight: 400;
      }

      .prevent-select {
        -webkit-user-select: none; /* Safari */
        -ms-user-select: none; /* IE 10 and IE 11 */
        user-select: none; /* Standard syntax */
      }

      body {
        font-family: "IranYekan", system-ui, -apple-system, sans-serif;
        direction: rtl;
        padding: 0;
        margin: 0;
        height: 100dvh;
        overflow-y: visible !important;
      }

      .table-container {
        margin: 20px;
        /* overflow-x: auto; */
        overflow-y: visible !important;
        position: relative; /* Add this */
        /* height: 100%; */
      }

      /* Update table styles */
      table {
        border-collapse: collapse;
        width: fit-content;
        max-width: none;
        border: 1px solid #ddd;
        table-layout: fixed;
        position: relative;
        overflow-y: visible !important;
      }

      th {
        overflow-y: visible !important;
        border: 1px solid #ddd;
        padding: 8px;
        position: relative;
        text-align: right;
        background-color: #f5f5f5;
        font-weight: bold;
        cursor: pointer;
        min-width: 150px;
        width: 150px;
        white-space: nowrap; /* Prevent text wrapping */
        text-overflow: ellipsis;
      }

      td {
        border: 1px solid #ddd;
        padding: 8px;
        position: relative;
        text-align: right;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
        width: fit-content;
        overflow-y: visible !important;
      }

      th:hover {
        background-color: #edecec;
      }

      .resizer {
        position: absolute;
        left: 0; /* Changed from right to left for RTL */
        top: 0;
        height: 100%;
        width: 5px;
        background: rgba(0, 0, 0, 0.1);
        opacity: 0;
        cursor: col-resize;
        user-select: none;
      }

      .resizer:hover {
        background: rgba(0, 0, 0, 0.3);
        opacity: 1;
      }

      .resizing {
        cursor: col-resize;
        user-select: none;
      }

      /* Persian number class */
      .persian-number {
        direction: ltr;
        display: inline-block;
      }

      /* Dragging styles */
      .dragging {
        opacity: 0.5;
        background-color: #e0e0e0;
      }

      th.drag-over::after {
        position: absolute;
        content: "";
        /* border-left: 2px solid #2196f3; */
        width: 100%;
        height: 100%;
        inset: 0;
        background-color: rgba(0, 0, 0, 0.122);
      }

      /* Handle styles */
      .handle {
        cursor: move;
        padding: 4px;
        margin-left: 4px;
        color: #666;
        display: inline-block;
      }

      .handle:hover {
        color: #000;
      }

      /* Sort indicators */
      .sort-icon {
        display: inline-block;
        width: 16px;
        height: 16px;
        margin-right: 6px;
        position: relative;
        cursor: pointer;
      }

      .sort-icon::after {
        content: "â†•ï¸";
        position: absolute;
        inset: 0;
        margin-top: -2.5px;
        color: #999;
      }

      th[data-sort="asc"] .sort-icon::after {
        content: "â†‘";
        color: #2196f3;
      }

      th[data-sort="desc"] .sort-icon::after {
        content: "â†“";
        color: #2196f3;
      }

      /* Add spacing between handle and sort icon */
      .header-content {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      /* Add new styles for menu */
      .column-menu-button {
        padding: 2px 6px;
        background: #f5f5f5;
        border: 1px solid #ddd;
        border-radius: 3px;
        cursor: pointer;
        position: absolute;
        height: fit-content;
        left: 12px;
        top: 0;
        bottom: 0;
        margin: auto;
      }

      .column-menu {
        position: absolute;
        top: calc(100% - 12px);
        left: 12px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        display: none;
        z-index: 1000;
        min-width: 150px;
      }

      .column-menu.show {
        display: block;
        z-index: 1000;
      }

      .menu-item {
        padding: 8px 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .menu-item:hover {
        background: #f5f5f5;
      }

      .menu-separator {
        border-top: 1px solid #ddd;
        margin: 4px 0;
      }

      .hidden-column {
        display: none;
      }

      .menu-item.show-columns {
        position: relative;
      }

      .submenu {
        position: absolute;
        left: 100%;
        top: 0;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        display: none;
        min-width: 150px;
        z-index: 1001; /* Higher than parent menu */
      }

      .menu-item.show-columns:hover .submenu {
        display: block;
        z-index: 1001;
      }

      .checkbox-item {
        padding: 8px 12px;
        cursor: pointer;
      }

      .checkbox-item:hover {
        background: #f5f5f5;
      }

      .checkbox-item input {
        margin-left: 8px;
      }

      /* Filtering */

      .filter-container {
        display: flex;
        gap: 8px;
        padding: 8px 12px;
        flex-direction: column;
      }

      .filter-row {
        display: flex;
        flex-direction: column;
        gap: 8px;
        align-items: center;
      }

      .filter-input {
        padding: 4px 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-family: inherit;
        flex: 1;
      }

      .filter-select {
        padding: 4px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-family: inherit;
        min-width: 120px;
        width: 100%;
      }

      .menu-item.filter-column {
        padding: 0;
      }

      .apply-filter {
        background: #2196f3;
        color: white;
        border: none;
        padding: 4px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-family: inherit;
      }

      .apply-filter:hover {
        background: #1976d2;
      }

      .clear-filter {
        background: #f44336;
        color: white;
        border: none;
        padding: 4px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-family: inherit;
      }

      .clear-filter:hover {
        background: #d32f2f;
      }

      .clear-all-filters {
        background: #f44336;
        color: white;
        border: none;
        padding: 4px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-family: inherit;
        margin: 8px 20px;
        display: none;
      }

      .clear-all-filters.visible {
        display: block;
      }

      .filter-badge {
        background: #e3f2fd;
        color: #1976d2;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.8em;
        margin-right: 8px;
        display: none;
        cursor: pointer;
      }

      .button-group {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
      }
    </style>
  </head>
  <body>
    <div class="table-container">
      <button class="clear-all-filters">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡ ÙÛŒÙ„ØªØ±Ù‡Ø§</button>

      <table id="resizable-table">
        <thead>
          <tr>
            <th data-col="0" data-sort="none">
              <div class="header-content">
                <span class="handle">â‹®â‹®</span>
                <span>Ù†Ø§Ù…</span>
                <div class="resizer"></div>
                <button class="column-menu-button">â˜°</button>
                <div class="column-menu">
                  <div class="menu-item filter-column">
                    <div class="filter-container">
                      <div class="filter-row">
                        <select class="filter-select">
                          <option value="equals">Ø¨Ø±Ø§Ø¨Ø± Ø§Ø³Øª Ø¨Ø§</option>
                          <option value="not-equals">Ø¨Ø±Ø§Ø¨Ø± Ù†ÛŒØ³Øª Ø¨Ø§</option>
                          <option value="starts-with">Ø´Ø±ÙˆØ¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ø¨Ø§</option>
                          <option value="contains">Ø´Ø§Ù…Ù„</option>
                          <option value="not-contains">Ø´Ø§Ù…Ù„ Ù†ÛŒØ³Øª</option>
                          <option value="ends-with">Ù¾Ø§ÛŒØ§Ù† Ù…ÛŒâ€ŒÛŒØ§Ø¨Ø¯ Ø¨Ø§</option>
                          <option value="is-empty">Ø®Ø§Ù„ÛŒ Ø§Ø³Øª</option>
                          <option value="is-not-empty">Ø®Ø§Ù„ÛŒ Ù†ÛŒØ³Øª</option>
                        </select>
                        <input type="text" class="filter-input" placeholder="Ù…Ù‚Ø¯Ø§Ø± ÙÛŒÙ„ØªØ±..." />
                      </div>
                      <div class="button-group">
                        <button class="clear-filter">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†</button>
                        <button class="apply-filter">Ø§Ø¹Ù…Ø§Ù„</button>
                      </div>
                    </div>
                  </div>
                  <div class="menu-separator"></div>
                  <div class="menu-item hide-column">Ù¾Ù†Ù‡Ø§Ù† Ú©Ø±Ø¯Ù† Ø³ØªÙˆÙ†</div>
                  <div class="menu-separator"></div>
                  <div class="menu-item show-columns">
                    Ù†Ù…Ø§ÛŒØ´ Ø³ØªÙˆÙ†â€ŒÙ‡Ø§
                    <div class="submenu"></div>
                  </div>
                </div>
                <span class="sort-icon"></span>
              </div>
            </th>
            <th data-col="1" class="" data-sort="none">
              <div class="header-content">
                <span class="handle">â‹®â‹®</span>
                <span>Ø³Ù†</span>
                <div class="resizer"></div>
                <button class="column-menu-button">â˜°</button>
                <div class="column-menu">
                  <div class="menu-item filter-column">
                    <div class="filter-container">
                      <div class="filter-row">
                        <select class="filter-select">
                          <option value="equals">Ø¨Ø±Ø§Ø¨Ø± Ø§Ø³Øª Ø¨Ø§</option>
                          <option value="not-equals">Ø¨Ø±Ø§Ø¨Ø± Ù†ÛŒØ³Øª Ø¨Ø§</option>
                          <option value="starts-with">Ø´Ø±ÙˆØ¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ø¨Ø§</option>
                          <option value="contains">Ø´Ø§Ù…Ù„</option>
                          <option value="not-contains">Ø´Ø§Ù…Ù„ Ù†ÛŒØ³Øª</option>
                          <option value="ends-with">Ù¾Ø§ÛŒØ§Ù† Ù…ÛŒâ€ŒÛŒØ§Ø¨Ø¯ Ø¨Ø§</option>
                          <option value="is-empty">Ø®Ø§Ù„ÛŒ Ø§Ø³Øª</option>
                          <option value="is-not-empty">Ø®Ø§Ù„ÛŒ Ù†ÛŒØ³Øª</option>
                        </select>
                        <input type="text" class="filter-input" placeholder="Ù…Ù‚Ø¯Ø§Ø± ÙÛŒÙ„ØªØ±..." />
                      </div>
                      <div class="button-group">
                        <button class="clear-filter">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†</button>
                        <button class="apply-filter">Ø§Ø¹Ù…Ø§Ù„</button>
                      </div>
                    </div>
                  </div>
                  <div class="menu-separator"></div>
                  <div class="menu-item hide-column">Ù¾Ù†Ù‡Ø§Ù† Ú©Ø±Ø¯Ù† Ø³ØªÙˆÙ†</div>
                  <div class="menu-separator"></div>
                  <div class="menu-item show-columns">
                    Ù†Ù…Ø§ÛŒØ´ Ø³ØªÙˆÙ†â€ŒÙ‡Ø§
                    <div class="submenu"></div>
                  </div>
                </div>
                <span class="sort-icon"></span>
              </div>
            </th>
            <th data-col="2" data-sort="none">
              <div class="header-content">
                <span class="handle">â‹®â‹®</span>
                <span>Ø´Ù‡Ø±</span>
                <div class="resizer"></div>
                <button class="column-menu-button">â˜°</button>
                <div class="column-menu">
                  <div class="menu-item filter-column">
                    <div class="filter-container">
                      <div class="filter-row">
                        <select class="filter-select">
                          <option value="equals">Ø¨Ø±Ø§Ø¨Ø± Ø§Ø³Øª Ø¨Ø§</option>
                          <option value="not-equals">Ø¨Ø±Ø§Ø¨Ø± Ù†ÛŒØ³Øª Ø¨Ø§</option>
                          <option value="starts-with">Ø´Ø±ÙˆØ¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ø¨Ø§</option>
                          <option value="contains">Ø´Ø§Ù…Ù„</option>
                          <option value="not-contains">Ø´Ø§Ù…Ù„ Ù†ÛŒØ³Øª</option>
                          <option value="ends-with">Ù¾Ø§ÛŒØ§Ù† Ù…ÛŒâ€ŒÛŒØ§Ø¨Ø¯ Ø¨Ø§</option>
                          <option value="is-empty">Ø®Ø§Ù„ÛŒ Ø§Ø³Øª</option>
                          <option value="is-not-empty">Ø®Ø§Ù„ÛŒ Ù†ÛŒØ³Øª</option>
                        </select>
                        <input type="text" class="filter-input" placeholder="Ù…Ù‚Ø¯Ø§Ø± ÙÛŒÙ„ØªØ±..." />
                      </div>
                      <div class="button-group">
                        <button class="clear-filter">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†</button>
                        <button class="apply-filter">Ø§Ø¹Ù…Ø§Ù„</button>
                      </div>
                    </div>
                  </div>
                  <div class="menu-separator"></div>
                  <div class="menu-item hide-column">Ù¾Ù†Ù‡Ø§Ù† Ú©Ø±Ø¯Ù† Ø³ØªÙˆÙ†</div>
                  <div class="menu-separator"></div>
                  <div class="menu-item show-columns">
                    Ù†Ù…Ø§ÛŒØ´ Ø³ØªÙˆÙ†â€ŒÙ‡Ø§
                    <div class="submenu"></div>
                  </div>
                </div>
                <span class="sort-icon"></span>
              </div>
            </th>
            <th data-col="3" class="" data-sort="none">
              <div class="header-content">
                <span class="handle">â‹®â‹®</span>
                <span>Ú©Ø´ÙˆØ±</span>
                <div class="resizer"></div>
                <button class="column-menu-button">â˜°</button>
                <div class="column-menu">
                  <div class="menu-item filter-column">
                    <div class="filter-container">
                      <div class="filter-row">
                        <select class="filter-select">
                          <option value="equals">Ø¨Ø±Ø§Ø¨Ø± Ø§Ø³Øª Ø¨Ø§</option>
                          <option value="not-equals">Ø¨Ø±Ø§Ø¨Ø± Ù†ÛŒØ³Øª Ø¨Ø§</option>
                          <option value="starts-with">Ø´Ø±ÙˆØ¹ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ø¨Ø§</option>
                          <option value="contains">Ø´Ø§Ù…Ù„</option>
                          <option value="not-contains">Ø´Ø§Ù…Ù„ Ù†ÛŒØ³Øª</option>
                          <option value="ends-with">Ù¾Ø§ÛŒØ§Ù† Ù…ÛŒâ€ŒÛŒØ§Ø¨Ø¯ Ø¨Ø§</option>
                          <option value="is-empty">Ø®Ø§Ù„ÛŒ Ø§Ø³Øª</option>
                          <option value="is-not-empty">Ø®Ø§Ù„ÛŒ Ù†ÛŒØ³Øª</option>
                        </select>
                        <input type="text" class="filter-input" placeholder="Ù…Ù‚Ø¯Ø§Ø± ÙÛŒÙ„ØªØ±..." />
                      </div>
                      <div class="button-group">
                        <button class="clear-filter">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†</button>
                        <button class="apply-filter">Ø§Ø¹Ù…Ø§Ù„</button>
                      </div>
                    </div>
                  </div>
                  <div class="menu-separator"></div>
                  <div class="menu-item hide-column">Ù¾Ù†Ù‡Ø§Ù† Ú©Ø±Ø¯Ù† Ø³ØªÙˆÙ†</div>
                  <div class="menu-separator"></div>
                  <div class="menu-item show-columns">
                    Ù†Ù…Ø§ÛŒØ´ Ø³ØªÙˆÙ†â€ŒÙ‡Ø§
                    <div class="submenu"></div>
                  </div>
                </div>
                <span class="sort-icon"></span>
              </div>
            </th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Ø¹Ù„ÛŒ Ù…Ø­Ù…Ø¯ÛŒ</td>
            <td><span class="persian-number">Û³Û°</span></td>
            <td>ØªÙ‡Ø±Ø§Ù†</td>
            <td>Ø§ÛŒØ±Ø§Ù†</td>
          </tr>
          <tr>
            <td>Ø§Ø±ÛŒÙ… Ø­Ø³ÛŒÙ†ÛŒ</td>
            <td><span class="persian-number">Û²Ûµ</span></td>
            <td>Ø§ØµÙÙ‡Ø§Ù†</td>
            <td>Ø§ÛŒØ±Ø§Ù†</td>
          </tr>
          <tr>
            <td>e Ø¨Ø« ØµØµØ¹Ø®Øµ Ø¯ ØµØ«Ø® Ø°ØµØ«Ø¨Ø¶Ø§ Ú©Ø±ÛŒÙ…ÛŒ</td>
            <td><span class="persian-number">Û³Ûµ</span></td>
            <td>Ø´ÛŒØ±Ø§Ø²</td>
            <td>Ø§ÛŒØ±Ø§Ù†</td>
          </tr>
          <tr>
            <td>Ù¾Ù„ÛŒ Ù…Ø­Ù…Ø¯ÛŒ</td>
            <td><span class="persian-number">Û³Û°</span></td>
            <td>ØªÙ‡Ø±Ø§Ù†</td>
            <td>Ø§ÛŒØ±Ø§Ù†</td>
          </tr>
          <tr>
            <td>Ø¹Ù„ÛŒ Ù…Ø­Ù…Ø¯ÛŒ</td>
            <td><span class="persian-number">Û³Û°</span></td>
            <td>ØªÙ‡Ø±Ø§Ù†</td>
            <td>Ø§ÛŒØ±Ø§Ù†</td>
          </tr>
          <tr>
            <td>Ø¹Ù„ÛŒ Ù…Ø­Ù…Ø¯ÛŒ</td>
            <td><span class="persian-number">Û³Û°</span></td>
            <td>ØªÙ‡Ø±Ø§Ù†</td>
            <td>Ø§ÛŒØ±Ø§Ù†</td>
          </tr>
        </tbody>
      </table>
    </div>

    <script>
      // Convert Persian numbers to English for sorting
      function convertPersianToEnglish(str) {
        const persianNumbers = ["Û°", "Û±", "Û²", "Û³", "Û´", "Ûµ", "Û¶", "Û·", "Û¸", "Û¹"];
        return str.replace(/[Û°-Û¹]/g, d => persianNumbers.indexOf(d));
      }

      function createTable() {
        const table = document.getElementById("resizable-table");
        const headers = table.querySelectorAll("th");
        let draggingCol = null;
        let startX, startWidth;
        let draggedHeader = null;
        const LOCAL_STORAGE_KEY = "tableColumnStates";
        const COLUMN_ORDER_KEY = "tableColumnOrder";

        // Load column order from localStorage or initialize default order
        let columnOrder = JSON.parse(localStorage.getItem(COLUMN_ORDER_KEY)) || Array.from(headers).map((_, index) => index);

        // Apply initial column order
        function applyColumnOrder() {
          const rows = table.querySelectorAll("tr");
          rows.forEach(row => {
            const cells = Array.from(row.children);
            const reorderedCells = columnOrder.map(index => cells[index]);
            row.innerHTML = "";
            reorderedCells.forEach(cell => row.appendChild(cell));
          });
        }
        // Call this on initial load
        applyColumnOrder();

        function sortingHandler(e, header) {
          // Ignore click if it's on handle or resizer
          if (
            e.target.classList.contains("handle") ||
            e.target.classList.contains("resizer") ||
            e.target.classList.contains("column-menu-button") ||
            e.target.closest(".column-menu")
          ) {
            return;
          }

          // Get the current column index based on DOM position
          const currentIndex = Array.from(header.parentElement.children).indexOf(header);

          const currentSort = header.getAttribute("data-sort");

          // Reset all other headers
          headers.forEach(h => {
            if (h !== header) h.setAttribute("data-sort", "none");
          });

          // Cycle through sort states
          let newSort;
          switch (currentSort) {
            case "none":
              newSort = "asc";
              break;
            case "asc":
              newSort = "desc";
              break;
            case "desc":
              newSort = "none";
              break;
          }

          header.setAttribute("data-sort", newSort);

          // Get table data and sort
          const tbody = table.querySelector("tbody");
          const rows = Array.from(tbody.querySelectorAll("tr"));

          if (newSort !== "none") {
            rows.sort((a, b) => {
              let aVal = a.cells[currentIndex].textContent.trim();
              let bVal = b.cells[currentIndex].textContent.trim();

              console.log(aVal, bVal);

              // Convert Persian numbers for comparison if needed
              if (a.cells[currentIndex].querySelector(".persian-number")) {
                aVal = convertPersianToEnglish(aVal);
                bVal = convertPersianToEnglish(bVal);
                aVal = parseInt(aVal);
                bVal = parseInt(bVal);
              }

              if (newSort === "asc") {
                return bVal.toString().localeCompare(aVal.toString(), "fa");
              } else {
                return aVal.toString().localeCompare(bVal.toString(), "fa");
              }
            });
          } else {
            // Reset to original order based on DOM position
            rows.sort((a, b) => {
              return Array.from(tbody.children).indexOf(a) - Array.from(tbody.children).indexOf(b);
            });
          }

          // Reorder the table
          rows.forEach(row => tbody.appendChild(row));
        }

        // Column resizing functionality
        headers.forEach(header => {
          header.addEventListener("click", e => {
            sortingHandler(e, header);
          });

          header.style.width = `${header.offsetWidth}px`;

          const resizer = header.querySelector(".resizer");
          if (resizer) {
            resizer.addEventListener("mousedown", function (e) {
              e.stopPropagation();
              e.preventDefault();
              draggingCol = header;
              startX = e.pageX;
              startWidth = header.offsetWidth;

              document.addEventListener("mousemove", onResize);
              document.addEventListener("mouseup", stopResize);

              table.classList.add("resizing");
            });
          }

          // Column moving functionality
          const handle = header.querySelector(".handle");
          handle.addEventListener("mousedown", function (e) {
            draggedHeader = header;
            header.classList.add("dragging");

            document.querySelector("table").classList.add("prevent-select");

            document.addEventListener("mousemove", onMove);
            document.addEventListener("mouseup", stopMove);
          });
        });

        function onResize(e) {
          if (draggingCol) {
            // Calculate the difference from the starting point
            const diffX = e.pageX - startX;
            // For RTL, we need to invert the difference
            const newWidth = Math.max(startWidth - diffX, 150); // Minimum width of 100px
            draggingCol.style.width = `${newWidth}px`;

            // headers.forEach(header => {
            //   console.log(header.dataset.col, header.clientWidth);
            //   header.style.width = `${header.clientWidth}px`;
            // });
          }
        }

        function stopResize() {
          draggingCol = null;
          table.classList.remove("resizing");
          document.removeEventListener("mousemove", onResize);
          document.removeEventListener("mouseup", stopResize);

          // headers.forEach(header => {
          //   console.log(header.dataset.col, header.clientWidth);
          //   header.style.width = `${header.offsetWidth}px`;
          // });
        }

        function onMove(e) {
          e.preventDefault();
          headers.forEach(header => {
            if (header !== draggedHeader) {
              const rect = header.getBoundingClientRect();
              const min = rect.x;
              const max = rect.x + rect.width;

              header.classList.toggle("drag-over", e.clientX < max && e.clientX > min);
            }
          });
        }

        function stopMove() {
          document.querySelector("table").classList.remove("prevent-select");

          if (draggedHeader) {
            const dragOverHeader = table.querySelector("th.drag-over");
            if (dragOverHeader) {
              const draggedIndex = Array.from(draggedHeader.parentElement.children).indexOf(draggedHeader);
              const dropIndex = Array.from(dragOverHeader.parentElement.children).indexOf(dragOverHeader);

              // Update column order array
              const [removed] = columnOrder.splice(draggedIndex, 1);
              columnOrder.splice(dropIndex, 0, removed);

              // Save to localStorage
              localStorage.setItem(COLUMN_ORDER_KEY, JSON.stringify(columnOrder));

              // Swap columns in the table
              const rows = table.querySelectorAll("tr");
              rows.forEach(row => {
                const cells = row.children;
                const draggedCell = cells[draggedIndex];

                if (draggedIndex < dropIndex) {
                  row.insertBefore(draggedCell, cells[dropIndex].nextSibling);
                } else {
                  row.insertBefore(draggedCell, cells[dropIndex]);
                }
              });
            }

            draggedHeader.classList.remove("dragging");
            headers.forEach(header => header.classList.remove("drag-over"));
            draggedHeader = null;
          }

          document.removeEventListener("mousemove", onMove);
          document.removeEventListener("mouseup", stopMove);

          // Update column states after reordering
          const newStates = new Map();
          headers.forEach((header, newIndex) => {
            const originalIndex = parseInt(header.getAttribute("data-col"));
            const oldState = columnStates.get(originalIndex);
            if (oldState) {
              newStates.set(newIndex, {
                ...oldState,
                originalIndex: oldState.originalIndex,
              });
            }
          });
          columnStates.clear();
          newStates.forEach((state, index) => columnStates.set(index, state));
          updateAllSubmenus();
          saveVisibilityStates();
        }

        //
        // Menu
        //

        // Store column states globally
        const columnStates = new Map();

        // Load visibility states from localStorage
        function loadVisibilityStates() {
          try {
            const savedStates = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (savedStates) {
              return JSON.parse(savedStates);
            }
          } catch (error) {
            console.error("Error loading visibility states:", error);
          }
          return {};
        }

        // Save visibility states to localStorage
        function saveVisibilityStates() {
          const states = {};
          columnStates.forEach((state, index) => {
            states[state.name] = state.visible;
          });
          localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(states));
        }

        // Initialize column states
        function initializeColumnStates() {
          const savedStates = loadVisibilityStates();

          Array.from(headers).forEach((header, index) => {
            const columnName = header.querySelector(".header-content span:nth-child(2)")?.textContent;
            const isVisible = savedStates.hasOwnProperty(columnName) ? savedStates[columnName] : true;

            columnStates.set(index, {
              name: columnName,
              visible: isVisible,
              originalIndex: index,
            });
          });

          // Apply initial visibility states
          updateColumnVisibility();
        }

        function updateSubmenu(submenu) {
          submenu.innerHTML = "";
          const sortedStates = Array.from(columnStates.entries()).sort((a, b) => a[1].originalIndex - b[1].originalIndex);

          sortedStates.forEach(([index, state]) => {
            const item = document.createElement("div");
            item.className = "checkbox-item";

            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.checked = state.visible;

            checkbox.addEventListener(
              "change",
              (function (columnIndex) {
                return function (e) {
                  e.stopPropagation();
                  toggleColumn(columnIndex, e.target.checked);
                  updateAllSubmenus();
                  saveVisibilityStates();
                };
              })(index)
            );

            const label = document.createElement("label");
            label.textContent = state.name;

            item.appendChild(checkbox);
            item.appendChild(label);
            submenu.appendChild(item);
          });
        }

        function updateAllSubmenus() {
          const allSubmenus = table.querySelectorAll(".submenu");
          allSubmenus.forEach(submenu => {
            updateSubmenu(submenu);
          });
        }

        function toggleColumn(index, visible) {
          const state = columnStates.get(index);
          if (state) {
            state.visible = visible;
            updateColumnVisibility();
            saveVisibilityStates();
          }
        }

        function hideColumn(index) {
          toggleColumn(index, false);
          updateAllSubmenus();
        }

        function updateColumnVisibility() {
          headers.forEach((header, index) => {
            const state = columnStates.get(index);
            if (state) {
              if (!state.visible) {
                header.classList.add("hidden-column");
              } else {
                header.classList.remove("hidden-column");
              }
            }
          });

          const rows = table.querySelectorAll("tbody tr");
          rows.forEach(row => {
            Array.from(row.cells).forEach((cell, index) => {
              const state = columnStates.get(index);
              if (state) {
                if (!state.visible) {
                  cell.classList.add("hidden-column");
                } else {
                  cell.classList.remove("hidden-column");
                }
              }
            });
          });
        }

        function initializeMenus() {
          const menuButtons = table.querySelectorAll(".column-menu-button");

          document.addEventListener("click", e => {
            if (!e.target.closest(".column-menu-button")) {
              table.querySelectorAll(".column-menu.show").forEach(menu => {
                menu.classList.remove("show");
              });
            }
          });

          menuButtons.forEach((button, index) => {
            const menu = button.nextElementSibling;

            button.addEventListener("click", e => {
              e.stopPropagation();
              table.querySelectorAll(".column-menu.show").forEach(m => {
                if (m !== menu) m.classList.remove("show");
              });
              menu.classList.toggle("show");
            });

            menu.addEventListener("click", e => e.stopPropagation());

            const hideButton = menu.querySelector(".hide-column");
            hideButton.addEventListener("click", e => {
              e.stopPropagation();
              hideColumn(index);
              menu.classList.remove("show");
              saveVisibilityStates();
            });

            updateSubmenu(menu.querySelector(".submenu"));
          });
        }

        // Handle column reordering
        const originalStopMove = stopMove;
        stopMove = function () {
          originalStopMove();
          const newStates = new Map();
          headers.forEach((header, newIndex) => {
            const originalIndex = parseInt(header.getAttribute("data-col"));
            const oldState = columnStates.get(originalIndex);
            if (oldState) {
              newStates.set(newIndex, {
                ...oldState,
                originalIndex: oldState.originalIndex,
              });
            }
          });
          columnStates.clear();
          newStates.forEach((state, index) => columnStates.set(index, state));
          updateAllSubmenus();
          saveVisibilityStates();
        };

        // Filtering

        const filters = new Map();

        function applyFilter(columnIndex, filterType, filterValue) {
          filters.set(columnIndex, { type: filterType, value: filterValue });
          updateTableFilters();
        }

        function clearFilter(columnIndex) {
          filters.delete(columnIndex);

          // Clear input and select values
          const header = headers[columnIndex];
          const menu = header.querySelector(".column-menu");
          const input = menu.querySelector(".filter-input");
          const select = menu.querySelector(".filter-select");

          if (input) input.value = "";
          if (select) select.selectedIndex = 0;

          updateTableFilters();
          updateClearAllFiltersButton();
        }

        const clearFilterButtons = table.querySelectorAll(".clear-filter");
        clearFilterButtons.forEach((button, index) => {
          button.addEventListener("click", () => {
            // Clear the filter input and reset select
            const container = button.closest(".filter-container");
            const input = container.querySelector(".filter-input");
            const select = container.querySelector(".filter-select");
            input.value = "";
            select.selectedIndex = 0;

            // Clear the filter from our filters Map
            clearFilter(index);

            // Hide menu after clearing filter
            container.closest(".column-menu").classList.remove("show");
          });
        });

        // Clear all filters button
        const clearAllFiltersButton = document.querySelector(".clear-all-filters");

        // Function to update clear all filters button visibility
        function updateClearAllFiltersButton() {
          clearAllFiltersButton.classList.toggle("visible", filters.size > 0);
        }

        clearAllFiltersButton.addEventListener("click", () => {
          // Clear all filter inputs and selects
          table.querySelectorAll(".filter-input").forEach(input => {
            input.value = "";
          });
          table.querySelectorAll(".filter-select").forEach(select => {
            select.selectedIndex = 0;
          });

          // Clear all filters
          filters.clear();
          updateTableFilters();

          // Hide filter badges
          table.querySelectorAll(".filter-badge").forEach(badge => {
            badge.style.display = "none";
          });
        });

        const originalUpdateTableFilters = updateTableFilters;
        function updateTableFilters() {
          const rows = table.querySelectorAll("tbody tr");

          rows.forEach(row => {
            let showRow = true;

            filters.forEach((filter, columnIndex) => {
              const cell = row.cells[columnIndex];
              const cellValue = cell.textContent.trim();
              const isPersianNumber = cell.querySelector(".persian-number") !== null;

              let testValue = cellValue;
              let filterValue = filter.value;

              if (isPersianNumber) {
                testValue = convertPersianToEnglish(testValue);
                filterValue = convertPersianToEnglish(filterValue);
              }

              switch (filter.type) {
                case "equals":
                  showRow = showRow && testValue === filterValue;
                  break;
                case "not-equals":
                  showRow = showRow && testValue !== filterValue;
                  break;
                case "starts-with":
                  showRow = showRow && testValue.startsWith(filterValue);
                  break;
                case "contains":
                  showRow = showRow && testValue.includes(filterValue);
                  break;
                case "not-contains":
                  showRow = showRow && !testValue.includes(filterValue);
                  break;
                case "ends-with":
                  showRow = showRow && testValue.endsWith(filterValue);
                  break;
                case "is-empty":
                  showRow = showRow && testValue === "";
                  break;
                case "is-not-empty":
                  showRow = showRow && testValue !== "";
                  break;
              }
            });

            row.style.display = showRow ? "" : "none";
          });

          // Update filter badges
          headers.forEach((header, index) => {
            const badge =
              header.querySelector(".filter-badge") ||
              (() => {
                const badge = document.createElement("span");
                badge.className = "filter-badge";
                badge.textContent = "ğŸ”";
                header.querySelector(".header-content").appendChild(badge);
                return badge;
              })();

            badge.style.display = filters.has(index) ? "inline-block" : "none";
          });

          // Update clear all filters button visibility
          updateClearAllFiltersButton();
        }

        // Update the filter initialization
        function initializeFilters() {
          const filterContainers = table.querySelectorAll(".filter-container");

          filterContainers.forEach((container, index) => {
            const select = container.querySelector(".filter-select");
            const input = container.querySelector(".filter-input");
            const applyButton = container.querySelector(".apply-filter");

            applyButton.addEventListener("click", () => {
              const filterType = select.value;
              const filterValue = input.value;

              if (filterType === "is-empty" || filterType === "is-not-empty" || filterValue) {
                applyFilter(index, filterType, filterValue);
              }

              // Hide menu after applying filter
              container.closest(".column-menu").classList.remove("show");
            });

            // Add input shortcuts
            input.addEventListener("keypress", e => {
              if (e.key === "Enter") {
                applyButton.click();
              }
            });
          });
        }

        // Initialize everything
        initializeColumnStates();
        initializeMenus();
        initializeFilters();
        // initializeClearFilters();
      }

      document.addEventListener("DOMContentLoaded", function () {
        createTable();
      });
    </script>
  </body>
</html>
